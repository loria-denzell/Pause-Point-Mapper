<script src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://kit.fontawesome.com/a88aac2ad2.js" crossorigin="anonymous"></script>
<script>
    const thresholdDiv = document.getElementById("threshold_opt");
    const fileInputDiv = document.getElementById("file_opt");
    const linkInputDiv = document.getElementById("link_opt");
    const thresholdFooterDiv = document.getElementById('inputDurationFooterDiv');
    
    //const dataSourceSelect = document.getElementById("data_src_type");
    const dataSourceInput = document.getElementById("data_src_type");

    $(document).ready(function () {
        //NAVIGATION
        var stravaAuthButton = document.getElementById('strava_auth'); 
        var stravaAuthLink = document.getElementById('auth_link');
        //INPUT FORM
        const startProcessForm = $('#startProcess').closest('form');
        //INPUT FIELDS
        const fileInput = document.getElementById('file-input');
        const submitButton = document.getElementById('startProcess');
        const inputFields = document.querySelectorAll('#inputForm input[type="url"], #inputForm input[type="range"], #inputForm select');
        
        const dropArea = document.getElementById('drop-area');
        const fileNameDisplay = document.getElementById('file-name');

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('highlight');
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.classList.remove('highlight');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('highlight');
            const file = e.dataTransfer.files[0];
            fileInput.files = e.dataTransfer.files;
            fileNameDisplay.textContent = file.name;
            thresholdDiv.style.display = "block";
        });

        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            fileNameDisplay.innerText = file.name;
        });
        
        $('#durationRange').on('input', function () {
            $('#currentValue').html('Current Value: <strong>' + $(this).val() + '</strong>');
        });

        const accessToken = getAccessTokenFromCookie();
        const optionToDisable = dataSourceInput.options[2];
        
        if (accessToken !== null) {
            const iconElement = document.createElement('i');
            iconElement.className = 'fab fa-strava'; 
            const textNode = document.createTextNode(' You are currently connected to STRAVA');
            stravaAuthLink.href = '';
            stravaAuthLink.disabled = true;
            stravaAuthButton.innerHTML = '';
            stravaAuthButton.appendChild(iconElement);
            stravaAuthButton.appendChild(textNode);
            stravaAuthButton.disabled = true;
            optionToDisable.disabled = false;
            optionToDisable.textContent = "Strava Activity Link"
        }else if(accessToken === null){
            $('#informationModal').modal('show');
            optionToDisable.disabled = true;
            optionToDisable.textContent += " (Connect to Strava First)"
        }

        startProcessForm.submit(function (event) {
            if (checkInputs()) {
                toggleSubmitButton();
                document.getElementById('inputForm').submit();
                if ($(event.target).is(startProcessForm)) {
                    $('#loadingModal').modal('show');
                }
            } else {
                alert('Please fill out all required fields.');
            }
        });

        function checkInputs() {
            let allFilled = true;
            inputFields.forEach(function (input) {
                if (input.required && !input.value.trim()) {
                    allFilled = false;
                }
            });

            const stravaDiv = window.getComputedStyle(stravaAuthLink);
            if (fileInput.files.length <= 0 && (stravaDiv.display === 'none' || stravaDiv.visibility === 'hidden')){
                allFilled = false;
            }
            return allFilled;
        }

        function toggleSubmitButton() {
            if (checkInputs()) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        inputFields.forEach(function (input) {
            input.addEventListener('input', toggleSubmitButton);
        });
    });

    dataSourceInput.addEventListener("change", function () {
        var selectedOption = this.value;
        fileInputDiv.style.display = "none"; 
        linkInputDiv.style.display = "none";

        var otherOptionDiv;
        var currentOptionDiv;

        if (selectedOption === "1") {
            fileInputDiv.style.display = "block";
            currentOptionDiv = fileInputDiv;
            otherOptionDiv = linkInputDiv;
        } else if (selectedOption === "2") {
            linkInputDiv.style.display = "block";
            currentOptionDiv = linkInputDiv;
            otherOptionDiv = fileInputDiv;
        }
        thresholdDurationInput(currentOptionDiv, otherOptionDiv, selectedOption)
    });

    function thresholdDurationInput(currentOptionDiv, otherOptionDiv, option) {
        var currentInput = currentOptionDiv.querySelector("input");
        var otherInput = otherOptionDiv.querySelector("input");
        if (otherInput) {
            otherInput.required = false;
        }
        currentInput.required = true;
        currentInput.addEventListener('input', function (event) {
            if (currentInput.value.trim() === '') {
                thresholdDiv.style.display = "none";
            } else {
                thresholdDiv.style.display = "block";
            }
        });
    }

    function getAccessTokenFromCookie() {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('access_token=')) {
                return cookie.substring('access_token='.length, cookie.length);
            }
        }
        return null;
    }

    var thresholdTooltip = new bootstrap.Tooltip(thresholdFooterDiv, {
        html: true,
        title: "<strong>For Example:</strong><br>If you choose '50' seconds as the minimum threshold, All 'gaps' between two trackpoints that are atleast 50 seconds will be automatically marked as a 'stop' and will be included in the output.",
        boundary: 'window',
        customClass: 'custom-tooltip',
    });
    
    {% if info %}
    const tableStats = document.getElementById('table_statistics');
    if (tableStats) {
        tableStats.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.getElementById('downloadMapHtmlBtn').addEventListener('click', function (event) {
        event.preventDefault();
        var mapHtmlContent = "{{ info.map_html|escapejs }}";
        var blob = new Blob([mapHtmlContent], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');

        a.href = url;
        a.download = 'map.html';
        document.body.appendChild(a);
        a.click();

        URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });
    
    {% endif %}
</script>